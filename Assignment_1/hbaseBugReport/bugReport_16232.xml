<!-- 
RSS generated by JIRA (6.3.4#6332-sha1:51bc225ef474afe3128b2f66878477f322397b16) at Fri Dec 16 21:11:51 UTC 2016

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HBASE-16232/HBASE-16232.xml?field=key&amp;field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>6.3.4</version>
        <build-number>6332</build-number>
        <build-date>15-08-2014</build-date>
    </build-info>

<item>
            <title>[HBASE-16232] ITBLL fails on branch-1.3, now loosing actual keys</title>
                <link>https://issues.apache.org/jira/browse/HBASE-16232</link>
                <project id="12310753" key="HBASE">HBase</project>
                    <description>&lt;p&gt;So I&apos;m running ITBLL off branch-1.3 on recent commit (after &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;&apos;s fix for fake keys showing up in the scans) with increased number of regions per regionserver and seeing the following.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;$Verify&#8203;$Counts	&lt;br/&gt;
REFERENCED	0	4,999,999,994	4,999,999,994&lt;br/&gt;
UNDEFINED	0	3	3&lt;br/&gt;
UNREFERENCED	0	3	3&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So we&apos;re loosing some keys. This time those aren&apos;t fake:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;undef	&lt;br/&gt;
\x89\x10\xE0\xBBx\xF1\xC4\xBAY`\xC4\xD77\x87\x84\x0F	0	1	1&lt;br/&gt;
\x89\x11\x0F\xBA@\x0D8^\xAE \xB1\xCAh\xEB&amp;amp;\xE3	0	1	1&lt;br/&gt;
\x89\x16waxv;\xB1\xE3Z\xE6&quot;|\xFC\xBE\x9A	0	1	1&lt;br/&gt;
unref	&lt;br/&gt;
\x15\x1F*f\x92i6\x86\x1D\x8E\xB7\xE1\xC1=\x96\xEF	0	1	1&lt;br/&gt;
\xF4G\xC6E\xD6\xF1\xAB\xB7\xDB\xC0\x94\xF2\xE7mN\xEC	0	1	1&lt;br/&gt;
U\x0F&apos;\x88\x106\x19\x1C\x87Y&quot;\xF3\xE6\xC1\xC8\x15&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Re-running verify step with CM off still shows this issue. Search tool reports:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Total&lt;br/&gt;
\x89\x11\x0F\xBA@\x0D8^\xAE \xB1\xCAh\xEB&amp;amp;\xE3	5	0	5&lt;br/&gt;
\x89\x16waxv;\xB1\xE3Z\xE6&quot;|\xFC\xBE\x9A	4	0	4&lt;br/&gt;
CELL_WITH_MISSING_ROW	15	0	15&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Will post more as I dig into.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12989585">HBASE-16232</key>
            <summary>ITBLL fails on branch-1.3, now loosing actual keys</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mantonov">Mikhail Antonov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 Jul 2016 21:43:14 +0000</created>
                <updated>Mon, 29 Aug 2016 08:32:09 +0000</updated>
                                            <version>1.3.0</version>
                    <version>1.2.1</version>
                                                    <component>dataloss</component>
                    <component>integration tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>14</watches>
                                                                <comments>
                            <comment id="15378450" author="mantonov" created="Thu, 14 Jul 2016 21:45:40 +0000"  >&lt;p&gt;I didn&apos;t not try this test config with 1.2.2 though, so not yet sure where the regression creeped in.&lt;/p&gt;</comment>
                            <comment id="15383273" author="stack" created="Mon, 18 Jul 2016 23:17:09 +0000"  >&lt;p&gt;Trying tip of 1.3 now.&lt;/p&gt;</comment>
                            <comment id="15383278" author="mantonov" created="Mon, 18 Jul 2016 23:21:51 +0000"  >&lt;p&gt;(I&apos;m using config where I&apos;m overriding num regions per RS to be way more than the default of 3 regions - like 50 or 100 per RS)&lt;/p&gt;</comment>
                            <comment id="15384453" author="stack" created="Tue, 19 Jul 2016 16:18:39 +0000"  >&lt;p&gt;My overnight passed on my eight node cluster (5 loops, 4B nodes each run). About 20 regions each. Let me up the test length.&lt;/p&gt;</comment>
                            <comment id="15384835" author="mantonov" created="Tue, 19 Jul 2016 20:55:04 +0000"  >&lt;p&gt;I&apos;d up the number of regions to something more.&lt;/p&gt;</comment>
                            <comment id="15386227" author="mantonov" created="Wed, 20 Jul 2016 17:14:54 +0000"  >&lt;p&gt;Got another repro on the tip of 1.3. Basically I&apos;m running in the loop and not deleting all tables for a while so I can debug it. This time had to go up to 600-800 regions per RS before observed lost keys.&lt;/p&gt;</comment>
                            <comment id="15386232" author="stack" created="Wed, 20 Jul 2016 17:16:55 +0000"  >&lt;p&gt;I&apos;ve been running 48 regions overnight. Did 5 loops. No issue for me.  Let me go bigger again.....&lt;/p&gt;</comment>
                            <comment id="15386390" author="mantonov" created="Wed, 20 Jul 2016 18:32:06 +0000"  >&lt;p&gt;48 total or per rs? I&apos;d say try upping that by order of magnitude..&lt;/p&gt;

&lt;p&gt;(digging in; search tool doesn&apos;t find any of the lost keys in oldWALs, though the oldWALs for time range in question are there)&lt;/p&gt;</comment>
                            <comment id="15386392" author="stack" created="Wed, 20 Jul 2016 18:33:54 +0000"  >&lt;p&gt;Per RS. I&apos;d be interested in Search not finding keys...&lt;/p&gt;</comment>
                            <comment id="15386652" author="mantonov" created="Wed, 20 Jul 2016 21:21:42 +0000"  >&lt;p&gt;So one observation I have so far, maybe completely irrelevant.&lt;/p&gt;

&lt;p&gt;During the time of generator run which led to lost keys I&apos;m seeing this in the logs, looking at one region, and I didn&apos;t see those on other runs:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN backup.HFileArchiver: Failed to archive class org.apache.hadoop.hbase.backup.HFileArchiver$FileableStoreFile, file:&amp;lt;cluster&amp;gt;/data/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/IntegrationTestBigLinkedList.5/ee81b123a9d48bf086d1a237c35c563b/tiny/81580c0a6d8f41cdb83a1e9abf6491df on &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; #0
java.io.FileNotFoundException: File/Directory &amp;lt;cluster&amp;gt;/data/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/IntegrationTestBigLinkedList.5/ee81b123a9d48bf086d1a237c35c563b/tiny/81580c0a6d8f41cdb83a1e9abf6491df does not exist.
	at org.apache.hadoop.hdfs.server.namenode.FSDirAttrOp.setTimes(FSDirAttrOp.java:121)
	at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.setTimes(FSNamesystem.java:1907)
	at org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.setTimes(NameNodeRpcServer.java:1222)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m then getting :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN backup.HFileArchiver: Failed to complete archive of: 
[class org.apache.hadoop.hbase.backup.HFileArchiver$FileableStoreFile, &amp;lt;cluster&amp;gt;/data/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/IntegrationTestBigLinkedList.5/ee81b123a9d48bf086d1a237c35c563b/tiny/32029c46f36e481b99a7af10900e533a, 
&amp;lt;8 more files here&amp;gt;]
 Those files are still in the original location, and they may slow down reads.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
FATAL regionserver.HRegionServer: ABORTING region server &amp;lt;server&amp;gt;: Unrecoverable exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; closing region IntegrationTestBigLinkedList.5,$rA\xC0gzW\x14,1468971262948.ee81b123a9d48bf086d1a237c35c563b., still finishing close
java.io.IOException: java.io.IOException: Failed to archive/delete all the files &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region:IntegrationTestBigLinkedList.5,$rA?gzW�,1468971262948.ee81b123a9d48bf086d1a237c35c563b., family:tiny into &amp;lt;cluster&amp;gt;/archive/data/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/IntegrationTestBigLinkedList.5/ee81b123a9d48bf086d1a237c35c563b/tiny. Something is probably awry on the filesystem.
	at org.apache.hadoop.hbase.regionserver.HRegion.doClose(HRegion.java:1516)
	at org.apache.hadoop.hbase.regionserver.HRegion.close(HRegion.java:1378)
	at org.apache.hadoop.hbase.regionserver.handler.CloseRegionHandler.process(CloseRegionHandler.java:138)
	at org.apache.hadoop.hbase.executor.EventHandler.run(EventHandler.java:129)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.io.IOException: Failed to archive/delete all the files &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; region:IntegrationTestBigLinkedList.5,$rA?gzW�,1468971262948.ee81b123a9d48bf086d1a237c35c563b., family:tiny into &amp;lt;cluster&amp;gt;/archive/data/&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;/IntegrationTestBigLinkedList.5/ee81b123a9d48bf086d1a237c35c563b/tiny. Something is probably awry on the filesystem.
	at org.apache.hadoop.hbase.backup.HFileArchiver.archiveStoreFiles(HFileArchiver.java:233)
	at org.apache.hadoop.hbase.regionserver.HRegionFileSystem.removeStoreFiles(HRegionFileSystem.java:424)
	at org.apache.hadoop.hbase.regionserver.HStore.removeCompactedfiles(HStore.java:2699)
	at org.apache.hadoop.hbase.regionserver.HStore.close(HStore.java:835)
	at org.apache.hadoop.hbase.regionserver.HStore.close(HStore.java:116)
	at org.apache.hadoop.hbase.regionserver.HRegion$2.call(HRegion.java:1498)
	at org.apache.hadoop.hbase.regionserver.HRegion$2.call(HRegion.java:1494)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	... 3 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and then&lt;/p&gt;

&lt;p&gt;ERROR executor.EventHandler: Caught throwable while processing event M_RS_CLOSE_REGION&lt;/p&gt;</comment>
                            <comment id="15386684" author="stack" created="Wed, 20 Jul 2016 21:43:02 +0000"  >&lt;p&gt;The original file name that could not be found is not same as those that follow.&lt;/p&gt;</comment>
                            <comment id="15386690" author="mantonov" created="Wed, 20 Jul 2016 21:47:43 +0000"  >&lt;p&gt;The file 81580c0a6d8f41cdb83a1e9abf6491df was in the list of files that comprised &quot;failed to compliete archive of&quot; list in the second snippet, I just left only first file in the list, sorry.&lt;/p&gt;

&lt;p&gt;WARN backup.HFileArchiver: Failed to complete archive of: &lt;/p&gt;
{list of files}
&lt;p&gt;, this file that wasn&apos;t found is in this list.&lt;/p&gt;</comment>
                            <comment id="15386724" author="stack" created="Wed, 20 Jul 2016 22:19:45 +0000"  >&lt;p&gt;If you search he NN log, does it say anything interesting about the missing file?&lt;/p&gt;</comment>
                            <comment id="15386851" author="mantonov" created="Wed, 20 Jul 2016 23:58:32 +0000"  >&lt;p&gt;no didn&apos;t see anything funny about it&lt;/p&gt;</comment>
                            <comment id="15388034" author="stack" created="Thu, 21 Jul 2016 16:57:10 +0000"  >&lt;p&gt;One of my big jobs completed overnight. Let me try and up region count for the second run.... But I am having trouble reproducing what you are seeing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mantonov&quot; class=&quot;user-hover&quot; rel=&quot;mantonov&quot;&gt;Mikhail Antonov&lt;/a&gt; I don&apos;t have the scale necessary? If you get a broke run, want to do a chat to see if can help debug?&lt;/p&gt;</comment>
                            <comment id="15388211" author="mantonov" created="Thu, 21 Jul 2016 18:44:44 +0000"  >&lt;p&gt;So I tried running tip of 1.3 client against the cluster running 1.2.1 (I couldn&apos;t break 1.2.1 setup before) and it lost keys. Starting to look at the client diffs. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15394195" author="mantonov" created="Tue, 26 Jul 2016 17:52:01 +0000"  >&lt;p&gt;With enough regions in the cluster overall (up to high tens thousands, though most were just empty) I got one failed run with lost keys on 1.2.1.&lt;/p&gt;</comment>
                            <comment id="15440174" author="mantonov" created="Fri, 26 Aug 2016 23:22:57 +0000"  >&lt;p&gt;Some update on this one and a quick summary. After spending lots of time chasing this w/ different configuration I&apos;ve tried here&apos;s my conclusion so far:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I can&apos;t reproduce it running on large distributed cluster with active Chaos Monkeys with default &quot;hbase.test.regions-per-server&quot; (3). This is fairly rigorous test and a good baseline.&lt;/li&gt;
	&lt;li&gt;I&apos;ve seen that very occasionally on the same cluster when I set num-regions-per-server to be 100. At this point sporadic test failures start to creep in when I run the loop long enough as occasionally some regions are getting stuck in transition and load generator or verifier MR tasks fail with retries exhausted exception.&lt;/li&gt;
	&lt;li&gt;I see it more often if I up number of regions to be like 300 per server, and that makes test iterations take longer and longer and aforementioned task crashes more often, making reproduction really painful and unreliable.&lt;/li&gt;
	&lt;li&gt;With 100 or 300 regions per machine I have seen this on the tip of then-1.2.1 branch build. That makes me think there might be something old lurking in existing code for a long time.&lt;/li&gt;
	&lt;li&gt;To the best of my knowledge, nobody else who ran ITBLL off 1.3 builds on real clusters (&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stack&quot; class=&quot;user-hover&quot; rel=&quot;stack&quot;&gt;stack&lt;/a&gt;?) was able to reproduce it, unlike the previous issues with fake keys, which was reasonably reproducible on small distributed cluster (I haven&apos;t seen any other jiras files on that or much activity here).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So based on that, I&apos;m going to lower the priority for this task to Major and make it non-blocker for release, while continuing looking into that in the background, because at this point I don&apos;t know any reliable and repeatable way to reproduce it in reasonable amount of time on reasonable cluster setup. If anybody has such repro on this, by all means please feel free to step up and pick this one up.&lt;/p&gt;</comment>
                            <comment id="15440187" author="stack" created="Fri, 26 Aug 2016 23:29:03 +0000"  >&lt;p&gt;I couldn&apos;t reproduce on my small cluster &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mantonov&quot; class=&quot;user-hover&quot; rel=&quot;mantonov&quot;&gt;Mikhail Antonov&lt;/a&gt; running tip of 1.3 branch. I tried but was more in the tens of regions per server.&lt;/p&gt;

&lt;p&gt;Thanks for update. I agree there is likely something in here. Lets come back to it.&lt;/p&gt;</comment>
                            <comment id="15440250" author="apurtell" created="Sat, 27 Aug 2016 00:01:02 +0000"  >&lt;p&gt;I have also been chasing sporadic failures due to regions in transition. I was seeing it for a while on a clusterdock virtual cluster hosted on a d2.4xlarge EC2 instance, so definitely at smaller scale. 1.2.0 and 1.1.6rc1 (and 0.98.21) were always good but for a time 1.2.2 was failing reliably. I tried to bisect between 1.2.0 and 1.2.2 but couldn&apos;t nail it down. Now I can no longer reproduce at all. Shame I didn&apos;t save logs when I could. I&apos;ll be looking at branch-1 head soon and if it turns up there will save off all logs&lt;/p&gt;</comment>
                            <comment id="15440256" author="apurtell" created="Sat, 27 Aug 2016 00:03:05 +0000"  >&lt;p&gt;Note: when tests completed for me they were always good. I never saw lost keys as the description on this issue mentions, only a failure to recover regions in transition after sequences like split then compact then kill 50% of regionservers. &lt;/p&gt;</comment>
                            <comment id="15440268" author="mantonov" created="Sat, 27 Aug 2016 00:09:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=apurtell&quot; class=&quot;user-hover&quot; rel=&quot;apurtell&quot;&gt;Andrew Purtell&lt;/a&gt; yeah, the reason this jira was originally classified as Blocker was because I observed the lost (undef / unref) keys which is obviously the most concerning thing, and when I said &quot;I&apos;m not aware of anyone able to repro it&quot; I implied &quot;repro lost keys&quot;, though repro of failing MR tasks (for RITs) is also a good data point.&lt;/p&gt;

&lt;p&gt;ITBLL generator phase failing because of regions getting stuck in transition is a different issue that doesn&apos;t qualify for the data loss IMO.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                        <customfieldname>Date of First Response</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>Mon, 18 Jul 2016 23:17:09 +0000</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30zxz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>